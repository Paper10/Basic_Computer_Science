# TCP/IP 4계층 모델

**인터넷 프로토콜 스위트( Internet Protocol Suite )**란 인터넷에서 노드들이 데이터를 주고받는데 쓰이는 **프로토콜의 집합**으로 **TCP/IP 4계층** 모델 또는 **OSI 7계층**으로 설명 가능하다

## 계층구조

OSI 7계층과 TCP/IP 4계층 모두 한 계층의 변화가 다른 계층에 영향을 주지 않는다는 특징을 기반으로 정의되었다.

**OSI 7계층**은 아래와 같이 분류한다

- 어플리케이션 계층
- 프레젠테이션 계층
- 세션 계층
- 전송 계층
- 네트워크 계층
- 데이터링크 계틍
- 물리 계층

이 모델에서 어플리케이션 계층 ~ 세션계층 부분과 데이터링크 계층 ~ 물리 계층 부분을 각각 하나로 통합한 모델이 아래의 TCP/IP 4계층이다

- **어플리케이션** 계층
- **전송** 계층
- **인터넷** 계층( 네트워크 계층 )
- **링크** 계층

### 어플리케이션 계층

사용자에게 실제 **서비스가 제공되는 계층**이며 FTP, HTTP, SSH, SMTP, DNS 등의 **응용프로그램**이 사용되는 프로토콜 계층이다.

- FTP : 파일 전송 프로토콜
- SSH : 암호화 네트워크 프로토콜
- HTTP : 인터넷 및 웹사이트를 이용하는데 사용되는 프로토콜
- SMTP : 이메일 전송을 위한 프로토콜
- DNS : 도메인과 IP를 매핑하는 서버

### 전송 계층

**송신자와 수신자를 연결**하는 서비스를 제공하는 계층으로 **데이터 흐름** 및 **신뢰성**을 제어하며 **어플리케이션 계층과 인터넷 계층** 사이의 중계역할을 담당한다. 대표적으로 **TCP,UDP**가 있다

- **TCP** : 패킷의 **순서를 보장**하고 패킷 **수신여부를 확인**하며 **신뢰성**을 구축하여 **가상회선 패킷 교환방식**을 사용한다
- **UDP** : 패킷의 순서보장 없이 수신여부를 확인하지 않으며 단순히 **빠르게 데이터를 전송**하는 **데이터 패킷 교환 방식**을 사용한다.

1. **가상회선 패킷 교환 방식**

각 패킷에 **가상회선 식별자***가 포함되며 **하나의 가상회선**을 설정하여 전송된다. 패킷을 모두 전송하면 가상회선이 해제되고 전송된 패킷들은 **순서대로** 도착하는 방식

2. **데이터그램 패킷 교환 방식**

패킷이 **독립적으로** 이동하며 **최적의 경로**를 선택하여 전송된다. 각 패킷은 **서로 다른 경로**로 전송될 수 있으며 **다른 순서**로 도착할 수 있다

TCP는 신뢰성을 확보한 연결을 진행할 떄 **3-way handshake** 과정을 거친다. UDP는 해당 과정을 거치지 않는다

1. **SYN**단계 : 클라이언트가 서버에게 **ISN**이 포함된 **SYN 패킷**을 전송한다 (클라이언트 ---1200---> 서버)
2. **SYN+ACK**단계 : 서버가 클라이언트의 **SYN 패킷을 수신**하고 **서버의 ISN**과 **클라이언트의 ISN+1** 값을 전송한다 (클라이언트 <---500,1201--- 서버)
3. **ACK**단계 : 서버의 패킷을 수신한 클라이언트가 **서버에게 받은 ISN+1값**을 전송한다 (클라이언트 ---501---> 서버)

-> **ISN** : **새로운 TCP연결**이 시작될때 할당되는 **시퀸스 번호**. 노드들은 해당 시퀸스번호에 따라 패킷의 처리를 결정한다

TCP의 연결이 해제될떄는 **4-way handshake**과정을 거친다

1. 클라이언트는 서버에게 **종료 패킷 FIN**을 전송하고 **FIN_wait**상태에 들어간다
2. 서버는 FIN이 전송되면 서버에게 **승인 패킷 ACK**를 전송하고 **CLOSE_wait** 상태에 들어간다. ACK를 전송받은 클라이언트는 **FIN_wait2** 상태에 들어간다
3. 서버는 ACK를 전송하고 **일정 시간 뒤**에 **종료패킷 FIN**을 전송한다
4. **FIN_wait2** 상태의 서버는 FIN을 전송받고 서버로 **ACK**를 전송한다. 서버는 ACK를 받으면 **CLOSED** 상태가 된다

2번쨰 handshake에서 클라이언트가 ACK를 전송받고 바로 종료되지 않고 **FIN을 다시 기다리는 이유**는 **지연된 패킷**을 마저 받는 시간을 확보하거나 마지막 단계에 ACK를 전송하여 클라이언트의 마지막 상태를 **ACK 수신** 이 아닌 **ACK 전송 후 종료** 상태로 만들기 위함이다.

### 인터넷 계층

장치로부터 받은 패킷을 **지정된 IP주소로 전송**하기 위해 사용되는 계층이며. 상대방의 패킷 **수신여부를 판단하지 않는** 비연결형적인 특징을 가진다. **IP,ARP,ICMP**등의 프로토콜이 사용된다

### 링크 계층

전선, 광섬유, 무선 등으로 **실제 데이터를 전송**하며 노드 사이의 **신호를 주고받는 규칙**을 정하는 계층이다. 이 계층은 물리계층과 데이터 계층으로 나눌 수 있다

- **물리 계층** : LAN 선을 통해 **실제 0과 1로 이루어진 데이터**를 전송하는 층
- **데이터 링크 계층** : **이더넷 프레임**을 통해 **에러확인, 흐름제어, 접근 제어**를 담당하는 계층

-> **이더넷 프레임** : 데이터링크 계층이 보내는 데이터의 형식

- **(Preamable 7)(SFD 1)(DMAC 6)(SMAC 6)(Ether Type 2)(Payload)(CRC 4)**
- Preamable : 이더넷 프레임의 **시작**을 알린다
- SFD( Start Frame Delimeter ) : 다음 바이트부터 **MAC 주소가 시작**됨을 알린다
- DMAC, SMAC : **수신 MAC주소, 송신 MAC주소**
- Ether Type : **IP 프로토콜** 정의 ( IPv4, IPv6 )
- Payload : 실제 **데이터**
- CRC : **에러**확인용 비트

1. 유선 랜

실제 선을 통해 데이터를 주고받으며 흔히 **LAN선**이라고 불리는 구리로 만들어진 **트위스트 페어 케이블**과 레이저가 선 내부를 계속 반사하며 전진하여 고속통신이 가능한 **광섬유 케이블**을 사용한다.

- **전이중화 통신**
 
통신하는 양쪽 노드가 **동시에 송수신이 가능**한 방식으로 **송신로와 수신로를 나누어** 데이터를 주고받는다. 현재의 **보편적인** 유선 LAN은 이 방법을 채택한다

- **CSMA/CD**( Carrier Sense Multiple Access wuth Collision Detection )

**반이중화 통신**중 하나로 송신로와 수신로를 구분하지 않은 **하나의 통신로**만을 사용하여 **데이터가 충돌하면 재전송**하도록 만들어진 방식.

2. 무선 랜( WLAN : Wireless Local Area Network )

무선 랜의 경우 2.4GHz와 5GHz의 **주파수 대역**을 사용한다

- **2.4GHz** : **장애물**에 강하지만 **전파간섭**이 잘 일어난다
- **5GHz** : 사용가능한 **채널이 많으며** 채널의 **동시사용**이 가능하여 상대적으로 꺠끗한 네트워크 환경 구축이 가능하다.

무선랜은 수신과 송신에 **같은 채널**을 사용해야 하기 떄문에 **반이중화 통신**을 사용한다.

- **반이중화 통신**( half duplex )

송수신이 모두 가능하지만 **송신과 수신이 동시에는 불가능한 하나의 채널**을 통해 **한방향**으로만 통신하는 방식이다. 장치가 수신을 시작하면 전송이 완료될때까지 **기다린 후** 송신이 시작된다. 또한 데이터를 동시에 전송했을떄의 충돌을 방지하는 **충돌 방지 시스템**이 필요하다

- **CSMA/CA**

**반이중화 통신**중 하나로 장치가 데이터를 송신하기 전에 **캐리어를 감지**하여 **사전에 충돌을 방지**하는 방식을 사용하며 아래 과정에 따라 이루어진다.

 - 데이터 송신 전 통신 가능한 무선 매체를 탐색한다
 - **캐리어 감지** : 사용하려는 **회선이 비어있는지 판단**한다
 - **IFS( Inter FrameSpace )** : **랜덤 시간**만큼 대기하며 회선이 아직 사용중일 경우 **점점 시간을 늘려가며** 대기한다
 - 회선의 사용이 끝나면 데이터를 전송한다

- **와이파이**

전자기기를 무선 LAN 신호에 연결이 가능하게 하는 기술이다. 공유기라고 불리는 **AP( Access Point )**가 유선LAN 신호를 무선LAN으로 바꾸어준다.

- **BSS( Basic Service Set )**

**AP를 중심으로 이루어진 기본 서비스 집합**으로 하나의 BSS 내부의 AP는 장치들과 자유롭게 통신 가능하지만 BSS **외부와 직접적인 통신은 불가능**하다.

- **ESS( Extended Service Set )**

하나이상의 **연결된 BSS 그룹**으로 ESS 내부에서 **장거리** 통신이 가능하며 **이동**이 자유롭다.

### 계층간 데이터 송수신 과정

데이터 송신부에서는 **어플리케이션 계층 -> 링크 계층**으로 진행되는 **캡슐화 과정**이, 데이터 수신부에서는 캡슐화된 데이터를 **링크 계층 -> 어플리케이션 계층**을 거쳐 처리하는 **비캡슐화 과정**이 진행된다

1. **캡슐화 과정**
   1. 어플리케이션 계층에서 데이터가 생성된다
   2. 전송 계층이 해당 데이터에 **TCP(L4) 헤더**를 붙여 **세그먼트, 데이터그램** 형식으로 바꾼다
   3. 인터넷 계층이 해당 데이터그램에 **IP(L3) 헤더**를 붙여 **패킷**형식으로 바꾼다
   4. 링크 계층이 해당 패킷의 앞에 **프레임 헤더**, 패킷의 뒤에 **프레임 트레일러**를 붙여 **프레임**으로 바꿔 수신부로 전송한다

2. **비캡슐화 과정**

수신부가 프레임의 **프레임 헤더**와 **프레임 트레일러**를 감지하여 캡슐화 과정의 역순으로 데이터의 헤더들을 제거하여 데이터를 수신한다

## PDU( Protocol Data Unit )

TCP_IP 4계층에서 **각 계층이 송수신하는 데이터의 단위**를 PDU라고 하며 **제어 관련 정보**들이 포함된 **헤더**와 **실제 데이터**인 **페이로드**로 이루어져 있다. 각 계층의 PDU의 명칭이 각각 다르다.

- 어플리케이션 계층 : **메세지**
- 전송 계층 : **데이터그램, 세그먼트**
- 인터넷 계층 : **패킷**
- 링크 계층 : **프레임**, **비트**(물리 계층)
